<section id="view-abrechnung">
  <div class="filters" aria-label="Abrechnungszeitraum wählen">
    <label class="select-label">
      <span>Jahr</span>
      <select id="billYear"></select>
    </label>
    <div class="filter-row">
      <div class="segmented" role="group" aria-label="Halbjahr">
        <button type="button" data-half="H1">H1 (Jan–Jun)</button>
        <button type="button" data-half="H2">H2 (Jul–Dez)</button>
      </div>
      <button class="btn ghost" type="button" id="billRefresh">Aktualisieren</button>
    </div>
  </div>

  <div class="card inner" id="billMine">
    <div class="row-space">
      <h3>Meine Abrechnung</h3>
      <p class="muted" id="billMinePeriod"></p>
    </div>
    <div class="sum-grid" id="billTotals">
      <div class="sum-box">
        <p class="muted small">Abgerechnet (Betrag)</p>
        <p class="highlight" id="billPaidTotal"></p>
      </div>
      <div class="sum-box">
        <p class="muted small">Potenzial (Satz)</p>
        <p class="highlight" id="billPossibleTotal"></p>
      </div>
    </div>
    <div class="pill" id="billMineSummary"></div>
    <div id="billMineList" class="list" style="margin-top: 10px;"></div>
  </div>
</section>

<script>
  const AbrechnungView = (() => {
    const els = {
      year: null,
      halfButtons: [],
      minePeriod: null,
      mineSummary: null,
      mineList: null,
      paidTotal: null,
      possibleTotal: null,
      refresh: null,
    };

    const state = {
      year: new Date().getFullYear(),
      half: new Date().getMonth() <= 5 ? 'H1' : 'H2',
      data: null,
    };

    function formatEuro(value) {
      const num = Number(value || 0);
      return `${num.toFixed(2)} €`;
    }

    function formatTitle(entry) {
      const parts = [entry.datum || entry.date || '', entry.gruppe || entry.group || entry.title || ''];
      return parts.filter(Boolean).join(' ');
    }

    function formatDetail(entry) {
      const times = [entry.start, entry.ende || entry.end].filter(Boolean).join('–');
      const details = [times, entry.ort || entry.location || ''].filter(Boolean);
      return details.join(' · ');
    }

    function normalizeMine(res) {
      if (res?.mine) {
        return {
          rows: Array.isArray(res.mine.rows) ? res.mine.rows : [],
          sum: Number(res.mine.sum_eur || res.mine.sum || 0),
        };
      }
      const rows = [];
      const addEntry = (entry, statusLabel) => {
        rows.push({
          title: formatTitle(entry),
          detail: formatDetail(entry),
          amount_eur: entry.amount ?? entry.amount_eur ?? entry.sum_eur ?? 0,
          status: statusLabel,
        });
      };
      (res?.items || []).forEach((it) => addEntry(it, 'Abgerechnet'));
      (res?.pending || []).forEach((it) => addEntry(it, it.status || 'Offen'));
      const sum = Number(res?.totalAmount || 0) + Number(res?.pendingTotalAmount || 0);
      return { rows, sum };
    }

    function renderMine() {
      if (!els.mineList || !els.mineSummary || !els.minePeriod) return;
      const mine = normalizeMine(state.data || {});
      const paidTotal = Number(state.data?.paidTotalAmount || 0);
      const possibleTotal = Number(state.data?.possibleTotalAmount || 0);
      els.minePeriod.textContent = `${state.half} ${state.year}`;
      els.mineSummary.textContent = `Summe: ${formatEuro(mine.sum)}`;
      if (els.paidTotal) els.paidTotal.textContent = formatEuro(paidTotal);
      if (els.possibleTotal) els.possibleTotal.textContent = formatEuro(possibleTotal);

      if (!mine.rows.length) {
        els.mineList.innerHTML = '<p class="muted">Keine Einträge im Zeitraum.</p>';
        return;
      }

      const frag = document.createDocumentFragment();
      mine.rows.forEach((row) => {
        const item = document.createElement('div');
        item.className = 'item';
        item.innerHTML = `
          <div class="itemMain">
            <div class="itemTitle">${row.title || formatTitle(row)}</div>
            <div class="itemSub">${row.detail || row.info || formatDetail(row)}</div>
            ${row.status ? `<div class="badges"><span class="badge">${row.status}</span></div>` : ''}
          </div>
          <div class="itemActions"><span class="highlight">${formatEuro(row.amount_eur)}</span></div>
        `;
        frag.appendChild(item);
      });
      els.mineList.innerHTML = '';
      els.mineList.appendChild(frag);
    }

    async function loadData() {
      const t = requireToken_();
      if (!t) {
        hardLogout_("Session abgelaufen.");
        return;
      }
      showSpinner(true);
      const res = await apiCall('apiBillingHalfyear', t, state.year, state.half);
      showSpinner(false);
      if (!res || !res.ok) {
        showToast(res?.error || 'Abrechnung nicht geladen', 'error');
        return;
      }
      state.data = res;
      renderMine();
    }

    function populateYearOptions() {
      if (!els.year) return;
      const current = new Date().getFullYear();
      const years = [current - 1, current, current + 1];
      els.year.innerHTML = '';
      years.forEach((y) => {
        const opt = document.createElement('option');
        opt.value = y;
        opt.textContent = y;
        if (y === state.year) opt.selected = true;
        els.year.appendChild(opt);
      });
    }

    function setHalf(half) {
      state.half = half;
      els.halfButtons.forEach((btn) => btn.classList.toggle('active', btn.dataset.half === half));
      loadData();
    }

    function bindEvents() {
      if (els.year) {
        els.year.addEventListener('change', (ev) => {
          state.year = Number(ev.target.value) || state.year;
          loadData();
        });
      }
      els.halfButtons.forEach((btn) => {
        btn.addEventListener('click', () => setHalf(btn.dataset.half));
      });
      if (els.refresh) {
        els.refresh.addEventListener('click', () => loadData());
      }
    }

    function initElements() {
      els.year = document.querySelector('#billYear');
      els.halfButtons = Array.from(document.querySelectorAll('[data-half]'));
      els.minePeriod = document.querySelector('#billMinePeriod');
      els.mineSummary = document.querySelector('#billMineSummary');
      els.mineList = document.querySelector('#billMineList');
      els.paidTotal = document.querySelector('#billPaidTotal');
      els.possibleTotal = document.querySelector('#billPossibleTotal');
      els.refresh = document.querySelector('#billRefresh');
    }

    function setData(bootstrap) {
      state.data = null;
      loadData();
    }

    function init() {
      initElements();
      populateYearOptions();
      bindEvents();
      setHalf(state.half);
    }

    return { init, setData };
  })();
</script>
