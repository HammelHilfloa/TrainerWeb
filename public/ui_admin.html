<section id="view-admin">
  <div class="admin-subnav segmented" aria-label="Admin Tabs">
    <button type="button" class="active" data-tab="dashboard">Übersicht</button>
    <button type="button" data-tab="trainings">Trainings</button>
    <button type="button" data-tab="turniere">Turniere</button>
    <button type="button" data-tab="users">Benutzer</button>
    <button type="button" data-tab="billing">Abrechnung</button>
  </div>

  <div id="adminError" class="form-error" hidden></div>

  <div class="admin-tab" data-tab="dashboard">
    <div class="kpi-grid" id="adminKpiGrid">
      <div class="card kpi-card">
        <p class="muted">Bevorstehende Trainings</p>
        <div class="kpi-value" id="kpiUpcoming">–</div>
      </div>
      <div class="card kpi-card">
        <p class="muted">Offene Slots</p>
        <div class="kpi-value" id="kpiOpenSlots">–</div>
      </div>
      <div class="card kpi-card">
        <p class="muted">Offene Check-ins</p>
        <div class="kpi-value" id="kpiOpenCheckins">–</div>
      </div>
      <div class="card kpi-card">
        <p class="muted">Trainings diese Woche</p>
        <div class="kpi-value" id="kpiWeek">–</div>
      </div>
    </div>
  </div>

  <div class="admin-tab" data-tab="trainings" hidden>
    <div class="section-title">Trainings verwalten</div>
    <div class="filter-row admin-filters">
      <label class="select-label">
        <span>Monat</span>
        <input type="month" id="adminTrainingMonth" />
      </label>
      <label class="select-label">
        <span>Status</span>
        <select id="adminTrainingStatus">
          <option value="">Alle</option>
          <option value="geplant">geplant</option>
          <option value="stattgefunden">stattgefunden</option>
          <option value="ausgefallen">ausgefallen</option>
        </select>
      </label>
      <div class="actions" style="align-self:flex-end;">
        <button class="btn" type="button" id="btnNewTraining">Neu</button>
      </div>
    </div>

    <div class="admin-flex">
      <div class="card" id="adminTrainingsList"></div>
      <form class="form-grid card" id="adminTrainingForm" autocomplete="off" novalidate>
        <h3>Training bearbeiten</h3>
        <input type="hidden" id="adminTrainingId" />
        <input type="hidden" id="adminTrainingPlanId" />
        <label class="select-label">
          <span>Datum</span>
          <input type="date" id="adminTrainingDate" />
        </label>
        <div class="row-space" style="gap:8px;">
          <label class="select-label" style="flex:1;">
            <span>Start</span>
            <input type="time" id="adminTrainingStart" />
          </label>
          <label class="select-label" style="flex:1;">
            <span>Ende</span>
            <input type="time" id="adminTrainingEnd" />
          </label>
        </div>
        <label class="select-label">
          <span>Gruppe</span>
          <input type="text" id="adminTrainingGroup" />
        </label>
        <label class="select-label">
          <span>Ort</span>
          <input type="text" id="adminTrainingLocation" />
        </label>
        <label class="select-label">
          <span>Status</span>
          <select id="adminTrainingState">
            <option value="geplant">geplant</option>
            <option value="stattgefunden">stattgefunden</option>
            <option value="ausgefallen">ausgefallen</option>
          </select>
        </label>
        <label class="select-label">
          <span>Benötigt Trainer</span>
          <input type="number" min="0" id="adminTrainingNeeded" />
        </label>
        <label class="select-label">
          <span>Ausfallgrund</span>
          <input type="text" id="adminTrainingReason" />
        </label>
        <div class="actions" style="gap:8px;">
          <button class="btn primary" type="submit">Speichern</button>
          <button class="btn ghost" type="button" id="btnDeleteTraining">Löschen</button>
        </div>
        <div class="divider" style="margin:8px 0;"></div>
        <h3>Trainingsplan</h3>
        <label class="select-label">
          <span>Plan Titel</span>
          <input type="text" id="adminPlanTitle" />
        </label>
        <label class="select-label">
          <span>Plan Inhalt</span>
          <textarea id="adminPlanContent" rows="3"></textarea>
        </label>
        <label class="select-label">
          <span>Plan Link</span>
          <input type="url" id="adminPlanLink" />
        </label>
        <div class="actions" style="gap:8px;">
          <button class="btn primary" type="button" id="btnSavePlan">Plan speichern</button>
          <button class="btn ghost" type="button" id="btnDeletePlan">Plan löschen</button>
        </div>
        <div id="adminPlanError" class="form-error" hidden></div>
      </form>
    </div>
  </div>

  <div class="admin-tab" data-tab="turniere" hidden>
    <div class="section-title">Turniere verwalten</div>
    <div class="admin-flex">
      <form class="form-grid card" id="adminTurnierForm" autocomplete="off" novalidate>
        <div class="row-space">
          <h3>Turnier bearbeiten</h3>
          <button class="btn ghost btn-small" type="button" id="btnNewTurnier">Neu</button>
        </div>
        <input type="hidden" id="adminTurnierId" />
        <label class="select-label">
          <span>Name</span>
          <input type="text" id="adminTurnierName" required />
        </label>
        <label class="select-label">
          <span>Datum von</span>
          <input type="date" id="adminTurnierVon" />
        </label>
        <label class="select-label">
          <span>Datum bis</span>
          <input type="date" id="adminTurnierBis" />
        </label>
        <label class="select-label">
          <span>Ort</span>
          <input type="text" id="adminTurnierOrt" />
        </label>
        <label class="select-label">
          <span>Pauschale Tag (€)</span>
          <input type="number" step="0.01" id="adminTurnierPauschale" />
        </label>
        <label class="select-label">
          <span>km-Satz (€)</span>
          <input type="number" step="0.01" id="adminTurnierKmSatz" />
        </label>
        <label class="select-label">
          <span>Bemerkung</span>
          <textarea id="adminTurnierBemerkung" rows="2"></textarea>
        </label>
        <div class="actions" style="gap:8px;">
          <button class="btn primary" type="submit">Speichern</button>
          <button class="btn ghost" type="button" id="btnDeleteTurnier">Löschen</button>
        </div>
      </form>
      <div class="card" id="adminTurnierList"></div>
    </div>
  </div>

  <div class="admin-tab" data-tab="users" hidden>
    <div class="section-title">Benutzer verwalten</div>
    <div class="admin-flex">
      <div class="card" id="adminTrainerList"></div>
      <form class="form-grid card" id="adminTrainerForm" autocomplete="off" novalidate>
        <h3>Trainer bearbeiten</h3>
        <input type="hidden" id="adminTrainerId" />
        <label class="select-label">
          <span>Name</span>
          <input type="text" id="adminTrainerName" />
        </label>
        <label class="select-label">
          <span>Email</span>
          <input type="email" id="adminTrainerEmail" />
        </label>
        <label class="select-label">
          <span>Rolle (Standard)</span>
          <select id="adminTrainerRole"></select>
        </label>
        <label class="select-label">
          <span>Stundensatz (€)</span>
          <input type="text" id="adminTrainerRate" readonly />
        </label>
        <label class="chip-toggle">
          <input type="checkbox" id="adminTrainerActive" />
          <span>Aktiv</span>
        </label>
        <label class="chip-toggle">
          <input type="checkbox" id="adminTrainerIsAdmin" />
          <span>Admin</span>
        </label>
        <label class="select-label">
          <span>PIN setzen (optional)</span>
          <input type="password" id="adminTrainerPin" inputmode="numeric" maxlength="8" />
        </label>
        <div class="row-space" style="align-items:flex-end; gap:8px;">
          <div style="flex:1;">
            <p class="muted" style="margin:0;">Letzter Login</p>
            <div id="adminTrainerLastLogin" class="text-strong">–</div>
          </div>
          <button class="btn ghost" type="button" id="btnResetTrainerPin">PIN zurücksetzen</button>
        </div>
        <div class="actions" style="gap:8px;">
          <button class="btn primary" type="submit">Speichern</button>
        </div>
        <div id="adminTrainerPinHint" class="muted" style="min-height:1.5em;"></div>
      </form>
    </div>
  </div>

  <div class="admin-tab" data-tab="billing" hidden>
    <div class="section-title">Abrechnung Überblick</div>
    <div class="filter-row admin-filters">
      <label class="select-label">
        <span>Jahr</span>
        <input type="number" id="adminBillingYear" min="2023" step="1" />
      </label>
      <div class="segmented" style="max-width:240px;">
        <button type="button" class="active" data-half="H1">H1</button>
        <button type="button" data-half="H2">H2</button>
      </div>
      <div class="actions" style="align-self:flex-end;">
        <button class="btn" type="button" id="btnReloadBilling">Aktualisieren</button>
      </div>
    </div>
    <div class="card" id="adminBillingTable"></div>
  </div>
</section>

<script>
  const AdminView = (() => {
    const state = {
      activeTab: 'dashboard',
      trainings: [],
      trainingFilters: { month: '', status: '' },
      roles: [],
      trainers: [],
      turniere: [],
      currentTurnier: null,
      billingHalf: 'H1',
    };

    const els = {};

    const truthy = (v) => {
      if (v === true) return true;
      const s = String(v || '').trim().toUpperCase();
      return ['TRUE', 'JA', '1', 'X'].includes(s);
    };

    function cacheElements() {
      els.section = document.querySelector('#view-admin');
      els.tabs = Array.from(document.querySelectorAll('.admin-subnav button'));
      els.tabPanels = Array.from(document.querySelectorAll('.admin-tab'));
      els.errorBox = document.querySelector('#adminError');

      els.kpiUpcoming = document.querySelector('#kpiUpcoming');
      els.kpiOpenSlots = document.querySelector('#kpiOpenSlots');
      els.kpiOpenCheckins = document.querySelector('#kpiOpenCheckins');
      els.kpiWeek = document.querySelector('#kpiWeek');

      els.trainingMonth = document.querySelector('#adminTrainingMonth');
      els.trainingStatus = document.querySelector('#adminTrainingStatus');
      els.trainingsList = document.querySelector('#adminTrainingsList');
      els.trainingForm = document.querySelector('#adminTrainingForm');
      els.trainingId = document.querySelector('#adminTrainingId');
      els.trainingPlanId = document.querySelector('#adminTrainingPlanId');
      els.trainingDate = document.querySelector('#adminTrainingDate');
      els.trainingStart = document.querySelector('#adminTrainingStart');
      els.trainingEnd = document.querySelector('#adminTrainingEnd');
      els.trainingGroup = document.querySelector('#adminTrainingGroup');
      els.trainingLocation = document.querySelector('#adminTrainingLocation');
      els.trainingState = document.querySelector('#adminTrainingState');
      els.trainingNeeded = document.querySelector('#adminTrainingNeeded');
      els.trainingReason = document.querySelector('#adminTrainingReason');
      els.btnNewTraining = document.querySelector('#btnNewTraining');
      els.btnDeleteTraining = document.querySelector('#btnDeleteTraining');
      els.planTitle = document.querySelector('#adminPlanTitle');
      els.planContent = document.querySelector('#adminPlanContent');
      els.planLink = document.querySelector('#adminPlanLink');
      els.planError = document.querySelector('#adminPlanError');
      els.btnSavePlan = document.querySelector('#btnSavePlan');
      els.btnDeletePlan = document.querySelector('#btnDeletePlan');

      els.turnierForm = document.querySelector('#adminTurnierForm');
      els.turnierList = document.querySelector('#adminTurnierList');
      els.turnierId = document.querySelector('#adminTurnierId');
      els.turnierName = document.querySelector('#adminTurnierName');
      els.turnierVon = document.querySelector('#adminTurnierVon');
      els.turnierBis = document.querySelector('#adminTurnierBis');
      els.turnierOrt = document.querySelector('#adminTurnierOrt');
      els.turnierPauschale = document.querySelector('#adminTurnierPauschale');
      els.turnierKmSatz = document.querySelector('#adminTurnierKmSatz');
      els.turnierBemerkung = document.querySelector('#adminTurnierBemerkung');
      els.btnNewTurnier = document.querySelector('#btnNewTurnier');
      els.btnDeleteTurnier = document.querySelector('#btnDeleteTurnier');

      els.trainerList = document.querySelector('#adminTrainerList');
      els.trainerForm = document.querySelector('#adminTrainerForm');
      els.trainerId = document.querySelector('#adminTrainerId');
      els.trainerName = document.querySelector('#adminTrainerName');
      els.trainerEmail = document.querySelector('#adminTrainerEmail');
      els.trainerRole = document.querySelector('#adminTrainerRole');
      els.trainerRate = document.querySelector('#adminTrainerRate');
      els.trainerActive = document.querySelector('#adminTrainerActive');
      els.trainerIsAdmin = document.querySelector('#adminTrainerIsAdmin');
      els.trainerPin = document.querySelector('#adminTrainerPin');
      els.trainerLastLogin = document.querySelector('#adminTrainerLastLogin');
      els.trainerPinHint = document.querySelector('#adminTrainerPinHint');
      els.btnResetTrainerPin = document.querySelector('#btnResetTrainerPin');

      els.billingYear = document.querySelector('#adminBillingYear');
      els.billingHalfButtons = Array.from(document.querySelectorAll('[data-half]'));
      els.btnReloadBilling = document.querySelector('#btnReloadBilling');
      els.billingTable = document.querySelector('#adminBillingTable');
    }

    function showError(message) {
      if (!els.errorBox) return;
      const text = String(message || '').trim();
      els.errorBox.textContent = text;
      els.errorBox.hidden = !text;
    }

    function setActiveTab(tab) {
      state.activeTab = tab;
      els.tabs.forEach((btn) => btn.classList.toggle('active', btn.dataset.tab === tab));
      els.tabPanels.forEach((panel) => {
        const match = panel.dataset.tab === tab;
        panel.hidden = !match;
      });

      if (tab === 'dashboard') loadDashboard();
      if (tab === 'trainings') loadTrainings();
      if (tab === 'turniere') loadTurniere();
      if (tab === 'users') loadUsers();
      if (tab === 'billing') loadBilling();
    }

    async function loadDashboard() {
      const res = await apiAuthed('apiAdminDashboard');
      if (!res?.ok) return showError(res?.error || 'Dashboard konnte nicht geladen werden.');
      showError('');
      if (els.kpiUpcoming) els.kpiUpcoming.textContent = res.upcomingCount ?? 0;
      if (els.kpiOpenSlots) els.kpiOpenSlots.textContent = res.openSlotsCount ?? 0;
      if (els.kpiOpenCheckins) els.kpiOpenCheckins.textContent = res.openCheckinsCount ?? 0;
      if (els.kpiWeek) els.kpiWeek.textContent = res.trainingsThisWeekCount ?? 0;
    }

    function renderTrainingList() {
      if (!els.trainingsList) return;
      if (!state.trainings.length) {
        els.trainingsList.innerHTML = '<p class="muted">Keine Trainings gefunden.</p>';
        return;
      }

      const frag = document.createDocumentFragment();
      state.trainings.forEach((tr) => {
        const card = document.createElement('article');
        card.className = 'card admin-training-card';
        card.innerHTML = `
          <div class="row-space">
            <div>
              <p class="muted">${tr.datum || ''} · ${tr.start || ''}–${tr.ende || ''}</p>
              <h3 style="margin:4px 0;">${tr.gruppe || ''}</h3>
              <p class="muted">${tr.ort || ''}</p>
            </div>
            <div class="badge">${tr.status || ''}</div>
          </div>
          <div class="row-space" style="margin-top:10px; gap:8px;">
            <small class="muted">Benötigt ${tr.benoetigt_trainer ?? ''}</small>
            <div class="actions" style="gap:8px;">
              <button class="btn ghost" type="button" data-action="edit">Bearbeiten</button>
              <button class="btn" type="button" data-action="status" data-status="${tr.status}">${tr.status === 'geplant' ? 'Status: geplant' : 'Status ändern'}</button>
              <button class="btn ghost" type="button" data-action="delete">Löschen</button>
            </div>
          </div>
        `;
        card.querySelector('[data-action="edit"]').addEventListener('click', () => fillTrainingForm(tr));
        card.querySelector('[data-action="delete"]').addEventListener('click', () => handleDeleteTraining(tr.training_id));
        card.querySelector('[data-action="status"]').addEventListener('click', () => {
          const next = tr.status === 'geplant' ? 'stattgefunden' : tr.status === 'stattgefunden' ? 'ausgefallen' : 'geplant';
          setTrainingStatus(tr.training_id, next);
        });
        frag.appendChild(card);
      });

      els.trainingsList.innerHTML = '';
      els.trainingsList.appendChild(frag);
    }

    async function loadTrainings() {
      const filters = { ...state.trainingFilters };
      const res = await apiAuthed('apiAdminListTrainings', filters);
      if (!res?.ok) return showError(res?.error || 'Trainings konnten nicht geladen werden.');
      showError('');
      state.trainings = Array.isArray(res.items) ? res.items : [];
      renderTrainingList();
    }

    function fillTrainingForm(tr) {
      if (!tr) return clearTrainingForm();
      if (els.trainingId) els.trainingId.value = tr.training_id || '';
      if (els.trainingDate) els.trainingDate.value = tr.datum_iso || '';
      if (els.trainingStart) els.trainingStart.value = tr.start_raw || '';
      if (els.trainingEnd) els.trainingEnd.value = tr.ende_raw || '';
      if (els.trainingGroup) els.trainingGroup.value = tr.gruppe || '';
      if (els.trainingLocation) els.trainingLocation.value = tr.ort || '';
      if (els.trainingState) els.trainingState.value = tr.status || 'geplant';
      if (els.trainingNeeded) els.trainingNeeded.value = tr.benoetigt_trainer ?? '';
      if (els.trainingReason) els.trainingReason.value = tr.ausfall_grund || '';
      loadTrainingPlan(tr.training_id);
    }

    function clearTrainingForm() {
      if (els.trainingId) els.trainingId.value = '';
      if (els.trainingDate) els.trainingDate.value = '';
      if (els.trainingStart) els.trainingStart.value = '';
      if (els.trainingEnd) els.trainingEnd.value = '';
      if (els.trainingGroup) els.trainingGroup.value = '';
      if (els.trainingLocation) els.trainingLocation.value = '';
      if (els.trainingState) els.trainingState.value = 'geplant';
      if (els.trainingNeeded) els.trainingNeeded.value = '';
      if (els.trainingReason) els.trainingReason.value = '';
      clearTrainingPlan();
    }

    async function saveTraining(overrides = null) {
      const payload = overrides || {
        training_id: els.trainingId?.value || '',
        datum: els.trainingDate?.value || '',
        start: els.trainingStart?.value || '',
        ende: els.trainingEnd?.value || '',
        gruppe: els.trainingGroup?.value || '',
        ort: els.trainingLocation?.value || '',
        status: els.trainingState?.value || 'geplant',
        benoetigt_trainer: els.trainingNeeded?.value || '',
        ausfall_grund: els.trainingReason?.value || '',
      };

      const res = await apiAuthed('apiAdminUpsertTraining', payload);
      if (!res?.ok) return showError(res?.error || 'Training konnte nicht gespeichert werden.');
      const trainingId = res.training_id || payload.training_id;
      const statusRes = await apiAuthed(
        'apiAdminSetTrainingStatus',
        trainingId,
        payload.status || 'geplant',
        payload.ausfall_grund || ''
      );
      if (!statusRes?.ok) return showError(statusRes?.error || 'Status konnte nicht gespeichert werden.');
      showError('');
      clearTrainingForm();
      loadTrainings();
    }

    async function setTrainingStatus(trainingId, status) {
      if (!trainingId) return;
      let reason = '';
      if (status === 'ausgefallen') {
        reason = prompt('Ausfallgrund (optional):', '') || '';
      }
      const res = await apiAuthed('apiAdminSetTrainingStatus', trainingId, status, reason);
      if (!res?.ok) return showError(res?.error || 'Status konnte nicht gespeichert werden.');
      showError('');
      if (els.trainingId?.value === String(trainingId)) {
        if (els.trainingState) els.trainingState.value = status;
        if (els.trainingReason) els.trainingReason.value = reason;
      }
      loadTrainings();
    }

    function setPlanError(msg) {
      if (!els.planError) return;
      const text = String(msg || '').trim();
      els.planError.textContent = text;
      els.planError.hidden = !text;
    }

    function clearTrainingPlan() {
      if (els.trainingPlanId) els.trainingPlanId.value = '';
      if (els.planTitle) els.planTitle.value = '';
      if (els.planContent) els.planContent.value = '';
      if (els.planLink) els.planLink.value = '';
      if (els.btnDeletePlan) els.btnDeletePlan.disabled = true;
      setPlanError('');
    }

    async function loadTrainingPlan(trainingId) {
      if (!trainingId) return clearTrainingPlan();
      const res = await apiAuthed('apiTrainingDetails', trainingId);
      if (!res?.ok) {
        clearTrainingPlan();
        return setPlanError(res?.error || 'Trainingsplan konnte nicht geladen werden.');
      }
      const plan = res.plan || null;
      if (els.trainingPlanId) els.trainingPlanId.value = plan?.plan_id || '';
      if (els.planTitle) els.planTitle.value = plan?.titel || '';
      if (els.planContent) els.planContent.value = plan?.inhalt || '';
      if (els.planLink) els.planLink.value = plan?.link || '';
      if (els.btnDeletePlan) els.btnDeletePlan.disabled = !plan?.plan_id;
      setPlanError('');
    }

    async function saveTrainingPlan() {
      const trainingId = els.trainingId?.value || '';
      if (!trainingId) return setPlanError('Bitte zuerst ein Training auswählen.');
      setPlanError('');
      const payload = {
        titel: els.planTitle?.value || '',
        inhalt: els.planContent?.value || '',
        link: els.planLink?.value || '',
      };
      const res = await apiAuthed('apiAdminUpsertTrainingPlan', trainingId, payload);
      if (!res?.ok) return setPlanError(res?.error || 'Plan konnte nicht gespeichert werden.');
      if (els.trainingPlanId) els.trainingPlanId.value = res.plan?.plan_id || '';
      if (els.btnDeletePlan) els.btnDeletePlan.disabled = !res.plan?.plan_id;
      setPlanError('');
    }

    async function deleteTrainingPlan() {
      const planId = els.trainingPlanId?.value || '';
      if (!planId) return setPlanError('Kein Trainingsplan zum Löschen vorhanden.');
      const res = await apiAuthed('apiAdminDeleteTrainingPlan', planId);
      if (!res?.ok) return setPlanError(res?.error || 'Plan konnte nicht gelöscht werden.');
      clearTrainingPlan();
    }

    async function loadTurniere() {
      const res = await apiAuthed('apiAdminListTurniere');
      if (!res?.ok) return showError(res?.error || 'Turniere konnten nicht geladen werden.');
      showError('');
      state.turniere = Array.isArray(res.items) ? res.items : [];
      renderTurnierList();
    }

    function renderTurnierList() {
      if (!els.turnierList) return;
      if (!state.turniere.length) {
        els.turnierList.innerHTML = '<p class="muted">Keine Turniere gefunden.</p>';
        return;
      }
      const items = state.turniere.slice().sort((a, b) => (a.datumVonTs || 0) - (b.datumVonTs || 0));
      const frag = document.createDocumentFragment();
      items.forEach((item) => {
        const row = document.createElement('div');
        row.className = 'list-row';
        const dateLabel = item.datum_bis ? `${item.datum_von} – ${item.datum_bis}` : item.datum_von || '';
        row.innerHTML = `
          <div>
            <p class="text-strong">${item.name || ''}</p>
            <p class="muted small">${dateLabel}</p>
          </div>
          <button type="button" class="btn ghost btn-small">Bearbeiten</button>
        `;
        row.querySelector('button')?.addEventListener('click', () => fillTurnierForm(item));
        frag.appendChild(row);
      });
      els.turnierList.innerHTML = '';
      els.turnierList.appendChild(frag);
    }

    function fillTurnierForm(turnier) {
      state.currentTurnier = turnier || null;
      if (els.turnierId) els.turnierId.value = turnier?.turnier_id || '';
      if (els.turnierName) els.turnierName.value = turnier?.name || '';
      if (els.turnierOrt) els.turnierOrt.value = turnier?.ort || '';
      if (els.turnierPauschale) els.turnierPauschale.value = turnier?.pauschale_tag_eur ?? '';
      if (els.turnierKmSatz) els.turnierKmSatz.value = turnier?.km_satz_eur ?? '';
      if (els.turnierBemerkung) els.turnierBemerkung.value = turnier?.bemerkung || '';

      const toIso = (val) => {
        if (!val) return '';
        const d = val instanceof Date ? val : new Date(val);
        if (Number.isNaN(d.getTime())) return '';
        return d.toISOString().slice(0, 10);
      };
      if (els.turnierVon) els.turnierVon.value = turnier?.datum_von_raw ? toIso(turnier.datum_von_raw) : '';
      if (els.turnierBis) els.turnierBis.value = turnier?.datum_bis_raw ? toIso(turnier.datum_bis_raw) : '';
      if (els.btnDeleteTurnier) els.btnDeleteTurnier.disabled = !turnier?.turnier_id;
    }

    function clearTurnierForm() {
      state.currentTurnier = null;
      if (els.turnierId) els.turnierId.value = '';
      if (els.turnierName) els.turnierName.value = '';
      if (els.turnierVon) els.turnierVon.value = '';
      if (els.turnierBis) els.turnierBis.value = '';
      if (els.turnierOrt) els.turnierOrt.value = '';
      if (els.turnierPauschale) els.turnierPauschale.value = '';
      if (els.turnierKmSatz) els.turnierKmSatz.value = '';
      if (els.turnierBemerkung) els.turnierBemerkung.value = '';
      if (els.btnDeleteTurnier) els.btnDeleteTurnier.disabled = true;
    }

    async function saveTurnier() {
      const payload = {
        turnier_id: els.turnierId?.value || '',
        name: els.turnierName?.value.trim() || '',
        datum_von: els.turnierVon?.value || '',
        datum_bis: els.turnierBis?.value || '',
        ort: els.turnierOrt?.value.trim() || '',
        pauschale_tag_eur: els.turnierPauschale?.value || '',
        km_satz_eur: els.turnierKmSatz?.value || '',
        bemerkung: els.turnierBemerkung?.value.trim() || '',
      };
      if (!payload.name) return showError('Bitte Namen für das Turnier angeben.');
      const res = await apiAuthed('apiAdminUpsertTurnier', payload);
      if (!res?.ok) return showError(res?.error || 'Turnier konnte nicht gespeichert werden.');
      showError('');
      clearTurnierForm();
      loadTurniere();
    }

    async function deleteTurnier() {
      const turnierId = els.turnierId?.value || '';
      if (!turnierId) return;
      if (!confirm('Turnier wirklich löschen?')) return;
      const res = await apiAuthed('apiAdminDeleteTurnier', turnierId);
      if (!res?.ok) return showError(res?.error || 'Turnier konnte nicht gelöscht werden.');
      showError('');
      clearTurnierForm();
      loadTurniere();
    }

    async function handleDeleteTraining(trainingId) {
      if (!trainingId) return;
      const res = await apiAuthed('apiAdminDeleteTraining', trainingId);
      if (!res?.ok) return showError(res?.error || 'Training konnte nicht gelöscht werden.');
      showError('');
      clearTrainingForm();
      loadTrainings();
    }

    async function loadRoles() {
      const res = await apiAuthed('apiAdminListRoles');
      if (!res?.ok) return showError(res?.error || 'Rollen konnten nicht geladen werden.');
      showError('');
      state.roles = Array.isArray(res.items) ? res.items : [];
      if (els.trainerRole) {
        els.trainerRole.innerHTML = '';
        state.roles.forEach((r) => {
          const opt = document.createElement('option');
          opt.value = r.rolle;
          opt.textContent = r.rolle;
          els.trainerRole.appendChild(opt);
        });
      }
    }

    function renderTrainerList() {
      if (!els.trainerList) return;
      if (!state.trainers.length) {
        els.trainerList.innerHTML = '<p class="muted">Keine Trainer gefunden.</p>';
        return;
      }
      const frag = document.createDocumentFragment();
      state.trainers.forEach((t) => {
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'list-item';
        btn.innerHTML = `
          <div>
            <div class="text-strong">${t.name || ''}</div>
            <div class="muted">${t.trainer_id || ''}</div>
          </div>
          <div class="muted">${t.rolle_standard || ''} · ${Number(t.stundensatz_eur_effective || 0).toFixed(2)} €</div>
        `;
        btn.addEventListener('click', () => fillTrainerForm(t));
        frag.appendChild(btn);
      });
      els.trainerList.innerHTML = '';
      els.trainerList.appendChild(frag);
    }

    function fillTrainerForm(t) {
      if (els.trainerId) els.trainerId.value = t.trainer_id || '';
      if (els.trainerName) els.trainerName.value = t.name || '';
      if (els.trainerEmail) els.trainerEmail.value = t.email || '';
      if (els.trainerRole) els.trainerRole.value = t.rolle_standard || '';
      if (els.trainerRate) els.trainerRate.value = Number(t.stundensatz_eur_effective || 0).toFixed(2);
      if (els.trainerActive) els.trainerActive.checked = truthy(t.aktiv);
      if (els.trainerIsAdmin) els.trainerIsAdmin.checked = truthy(t.is_admin);
      if (els.trainerPin) els.trainerPin.value = '';
      if (els.trainerLastLogin) els.trainerLastLogin.textContent = t.last_login || '–';
      if (els.trainerPinHint) els.trainerPinHint.textContent = '';
    }

    function clearTrainerForm() {
      if (els.trainerId) els.trainerId.value = '';
      if (els.trainerName) els.trainerName.value = '';
      if (els.trainerEmail) els.trainerEmail.value = '';
      if (els.trainerRole && els.trainerRole.options.length) els.trainerRole.selectedIndex = 0;
      if (els.trainerRate) els.trainerRate.value = '';
      if (els.trainerActive) els.trainerActive.checked = true;
      if (els.trainerIsAdmin) els.trainerIsAdmin.checked = false;
      if (els.trainerPin) els.trainerPin.value = '';
      if (els.trainerLastLogin) els.trainerLastLogin.textContent = '–';
      if (els.trainerPinHint) els.trainerPinHint.textContent = '';
    }

    async function loadUsers() {
      await loadRoles();
      const res = await apiAuthed('apiAdminListTrainers');
      if (!res?.ok) return showError(res?.error || 'Trainer konnten nicht geladen werden.');
      showError('');
      state.trainers = Array.isArray(res.items) ? res.items : [];
      renderTrainerList();
    }

    function updateTrainerRate() {
      const role = els.trainerRole?.value || '';
      const match = state.roles.find((r) => r.rolle === role);
      if (els.trainerRate) els.trainerRate.value = match ? Number(match.stundensatz_eur || 0).toFixed(2) : '';
    }

    async function saveTrainer() {
      const payload = {
        trainer_id: els.trainerId?.value || '',
        name: els.trainerName?.value || '',
        email: els.trainerEmail?.value || '',
        rolle_standard: els.trainerRole?.value || '',
        aktiv: els.trainerActive?.checked ? 'TRUE' : 'FALSE',
        is_admin: els.trainerIsAdmin?.checked ? 'TRUE' : 'FALSE',
        pin: els.trainerPin?.value || '',
      };

      const res = await apiAuthed('apiAdminUpsertTrainer', payload);
      if (!res?.ok) return showError(res?.error || 'Trainer konnte nicht gespeichert werden.');
      showError('');
      clearTrainerForm();
      loadUsers();
    }

    async function resetTrainerPin() {
      const id = els.trainerId?.value || '';
      if (!id) return;
      const res = await apiAuthed('apiAdminResetTrainerPin', id);
      if (!res?.ok) return showError(res?.error || 'PIN konnte nicht zurückgesetzt werden.');
      showError('');
      if (els.trainerPinHint) els.trainerPinHint.textContent = `Neue PIN: ${res.pin}`;
    }

    async function loadBilling() {
      const year = Number(els.billingYear?.value || new Date().getFullYear());
      const res = await apiAuthed('apiAdminBillingOverview', year, state.billingHalf);
      if (!res?.ok) return showError(res?.error || 'Abrechnung konnte nicht geladen werden.');
      showError('');
      renderBilling(res.items || []);
    }

    function renderBilling(items) {
      if (!els.billingTable) return;
      if (!items.length) {
        els.billingTable.innerHTML = '<p class="muted">Keine Daten.</p>';
        return;
      }
      const rows = items
        .map((row) => `
          <div class="table-row">
            <div class="cell strong">${row.name || row.trainer_id || ''}</div>
            <div class="cell">${Number(row.paidTotalAmount || 0).toFixed(2)} €</div>
            <div class="cell">${Number(row.possibleTotalAmount || 0).toFixed(2)} €</div>
            <div class="cell">${row.openCheckinsCount || 0}</div>
          </div>
        `)
        .join('');
      els.billingTable.innerHTML = `
        <div class="table header">
          <div class="cell">Trainer</div>
          <div class="cell">Ausgezahlt</div>
          <div class="cell">Möglich</div>
          <div class="cell">Offene Check-ins</div>
        </div>
        <div class="table body">${rows}</div>
      `;
    }

    function bindEvents() {
      els.tabs.forEach((btn) => {
        btn.addEventListener('click', () => setActiveTab(btn.dataset.tab));
      });

      if (els.trainingMonth) {
        els.trainingMonth.addEventListener('change', () => {
          state.trainingFilters.month = els.trainingMonth.value || '';
          loadTrainings();
        });
      }
      if (els.trainingStatus) {
        els.trainingStatus.addEventListener('change', () => {
          state.trainingFilters.status = els.trainingStatus.value || '';
          loadTrainings();
        });
      }
      if (els.btnNewTraining) {
        els.btnNewTraining.addEventListener('click', () => clearTrainingForm());
      }
      if (els.trainingForm) {
        els.trainingForm.addEventListener('submit', (ev) => {
          ev.preventDefault();
          saveTraining();
        });
      }
      if (els.btnDeleteTraining) {
        els.btnDeleteTraining.addEventListener('click', () => handleDeleteTraining(els.trainingId?.value));
      }
      if (els.btnSavePlan) {
        els.btnSavePlan.addEventListener('click', () => saveTrainingPlan());
      }
      if (els.btnDeletePlan) {
        els.btnDeletePlan.addEventListener('click', () => deleteTrainingPlan());
      }

      if (els.turnierForm) {
        els.turnierForm.addEventListener('submit', (ev) => {
          ev.preventDefault();
          saveTurnier();
        });
      }
      if (els.btnNewTurnier) {
        els.btnNewTurnier.addEventListener('click', () => clearTurnierForm());
      }
      if (els.btnDeleteTurnier) {
        els.btnDeleteTurnier.addEventListener('click', () => deleteTurnier());
      }

      if (els.trainerForm) {
        els.trainerForm.addEventListener('submit', (ev) => {
          ev.preventDefault();
          saveTrainer();
        });
      }
      if (els.trainerRole) {
        els.trainerRole.addEventListener('change', updateTrainerRate);
      }
      if (els.btnResetTrainerPin) {
        els.btnResetTrainerPin.addEventListener('click', resetTrainerPin);
      }

      if (els.billingHalfButtons?.length) {
        els.billingHalfButtons.forEach((btn) => {
          btn.addEventListener('click', () => {
            state.billingHalf = btn.dataset.half || 'H1';
            els.billingHalfButtons.forEach((b) => b.classList.toggle('active', b.dataset.half === state.billingHalf));
            loadBilling();
          });
        });
      }

      if (els.btnReloadBilling) {
        els.btnReloadBilling.addEventListener('click', () => loadBilling());
      }
    }

    function init() {
      cacheElements();
      if (!els.section) return;
      const now = new Date();
      if (els.billingYear) els.billingYear.value = now.getFullYear();
      bindEvents();
      if (typeof sessionUser !== 'undefined' && sessionUser && sessionUser.is_admin) {
        setActiveTab(state.activeTab);
      }
    }

    function setData() {
      // reserved for future bootstrap data
    }

    return { init, setData, setActiveTab };
  })();
</script>
