<section id="view-turniere" aria-live="polite">
  <div class="filters" aria-label="Turniere filtern">
    <label class="switch">
      <input type="checkbox" id="togglePastTurniere" />
      <span>Vergangene anzeigen</span>
    </label>
  </div>

  <div id="turniereList" class="turnier-list"></div>
</section>

<script>
  const TurniereView = (() => {
    const state = {
      showPast: false,
      turniereUpcoming: [],
      turnierePast: [],
      myStatus: new Map(),
      myFahrten: new Map(),
      detailsById: new Map(),
      user: null,
    };

    const els = {
      list: null,
      togglePast: null,
    };

    function initElements() {
      els.list = document.querySelector('#turniereList');
      els.togglePast = document.querySelector('#togglePastTurniere');
    }

    function init() {
      initElements();
      if (els.togglePast) {
        els.togglePast.addEventListener('change', () => {
          state.showPast = !!els.togglePast.checked;
          renderList();
        });
      }
    }

    function setData(data) {
      if (!data) return;
      state.user = data.user || state.user;
      state.turniereUpcoming = Array.isArray(data.turniere_upcoming) ? data.turniere_upcoming : [];
      state.turnierePast = Array.isArray(data.turniere_past) ? data.turniere_past : [];

      state.myStatus = new Map();
      (data.my_turniere || []).forEach((entry) => {
        state.myStatus.set(String(entry.turnier_id), entry);
      });

      state.myFahrten = new Map();
      (data.my_fahrten || []).forEach((f) => {
        state.myFahrten.set(String(f.turnier_id), f);
      });

      renderList();
    }

    function getActiveList() {
      return state.showPast ? state.turnierePast : state.turniereUpcoming;
    }

    function renderEmpty(message) {
      if (!els.list) return;
      els.list.innerHTML = `<p class="empty-hint">${message}</p>`;
    }

    function renderList() {
      if (!els.list) return;
      const items = getActiveList();
      if (!items.length) {
        renderEmpty('Keine Turniere gefunden.');
        return;
      }

      const frag = document.createDocumentFragment();
      items.forEach((turnier) => {
        const card = document.createElement('article');
        card.className = 'turnier-card card';
        card.addEventListener('click', () => toggleDetails(turnier.turnier_id, card));

        const dateLabel = turnier.datum_bis
          ? `${turnier.datum_von} – ${turnier.datum_bis}`
          : turnier.datum_von || '';

        const status = state.myStatus.get(String(turnier.turnier_id));
        const badge = renderStatusBadge(status);

        card.innerHTML = `
          <div class="turnier-top">
            <div>
              <p class="muted">${dateLabel}</p>
              <h3 class="turnier-title">${turnier.name || ''}</h3>
              <p class="muted">${turnier.ort || ''}</p>
            </div>
            <div class="badge-stack">${badge || ''}</div>
          </div>
        `;

        card.appendChild(createActions(turnier));

        const details = document.createElement('div');
        details.className = 'turnier-details';
        details.hidden = true;
        details.dataset.turnierId = turnier.turnier_id;
        card.appendChild(details);

        frag.appendChild(card);
      });

      els.list.innerHTML = '';
      els.list.appendChild(frag);
    }

    function renderStatusBadge(status) {
      if (!status || !status.anwesend) return '';
      const val = String(status.anwesend || '').toUpperCase();
      if (val === 'NICHT_VERFUEGBAR') return UIComponents.badge('Nicht verfügbar', 'danger');
      if (val === 'JA') return UIComponents.badge('Eingecheckt', 'success');
      if (val === 'OFFEN') return UIComponents.badge('Check-in offen', 'warning');
      return UIComponents.badge('Eingetragen', 'info');
    }

    function createActions(turnier) {
      const myStatus = state.myStatus.get(String(turnier.turnier_id));
      const container = document.createElement('div');
      container.className = 'pill-actions';

      const addButton = (label, handler, variant = 'ghost') => {
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = `btn btn-small ${variant}`;
        btn.textContent = label;
        btn.addEventListener('click', (ev) => {
          ev.stopPropagation();
          handler(btn);
        });
        container.appendChild(btn);
        return btn;
      };

      const hasActive = myStatus && isActiveTurnierStatus(myStatus.anwesend);
      const isUnavailable = myStatus && String(myStatus.anwesend).toUpperCase() === 'NICHT_VERFUEGBAR';

      if (!hasActive && !isUnavailable) {
        addButton('Eintragen', () => enroll(turnier), 'primary');
      }
      if (hasActive) {
        addButton('Austragen', () => withdraw(turnier), 'ghost');
      }
      addButton(isUnavailable ? 'Verfügbar' : 'Nicht verfügbar', () => {
        if (isUnavailable) {
          unsetUnavailable(turnier);
        } else {
          setUnavailable(turnier);
        }
      });
      if (hasActive && (!myStatus || String(myStatus.anwesend).toUpperCase() !== 'JA')) {
        addButton('Check-in', () => checkin(turnier), 'primary');
      }

      return container;
    }

    function toggleDetails(turnierId, cardEl) {
      const details = cardEl.querySelector('.turnier-details');
      if (!details) return;
      const isOpen = !details.hidden;
      document.querySelectorAll('.turnier-details').forEach((el) => {
        el.hidden = true;
        el.innerHTML = '';
      });
      if (isOpen) return;
      loadDetails(turnierId, details);
    }

    async function loadDetails(turnierId, container) {
      container.hidden = false;
      container.innerHTML = '<p class="muted">Lade Details …</p>';

      try {
        let details = state.detailsById.get(turnierId);
        if (!details) {
          const res = await apiAuthed('apiTurnierDetails', turnierId);
          if (!res || !res.ok) throw new Error(res && res.error ? res.error : 'Details konnten nicht geladen werden.');
          details = res;
          state.detailsById.set(turnierId, details);
        }
        renderDetails(container, details);
      } catch (err) {
        container.innerHTML = `<p class="error">${err && err.message ? err.message : err}</p>`;
      }
    }

    function renderDetails(container, details) {
      if (!container) return;
      const signups = Array.isArray(details.signups) ? details.signups : [];
      const unavailable = Array.isArray(details.unavailable) ? details.unavailable : [];
      const bemerkung = details.turnier && details.turnier.bemerkung ? `<p class="muted">${details.turnier.bemerkung}</p>` : '';

      const signupList = signups.length
        ? '<ul class="list">' +
          signups
            .map((s) => `<li><span>${s.name}</span><span class="muted">${s.rolle || ''}</span></li>`)
            .join('') +
          '</ul>'
        : '<p class="empty-hint">Keine Eintragungen.</p>';

      const unavailableList = unavailable.length
        ? '<ul class="list">' +
          unavailable
            .map((u) => `<li><span>${u.name}</span><span class="muted">${u.kommentar || ''}</span></li>`)
            .join('') +
          '</ul>'
        : '';

      container.innerHTML = `
        ${bemerkung}
        <div class="details-block">
          <h4>Eingetragene Trainer</h4>
          ${signupList}
        </div>
        ${unavailableList ? `<div class="details-block"><h4>Nicht verfügbar</h4>${unavailableList}</div>` : ''}
      `;
    }

    function isActiveTurnierStatus(status) {
      const val = String(status || '').toUpperCase();
      return val === 'OFFEN' || val === 'JA';
    }

    async function enroll(turnier) {
      const res = await apiAuthed('apiTurnierEnroll', turnier.turnier_id);
      if (!res || !res.ok) {
        showToast(res && res.error ? res.error : 'Eintragen fehlgeschlagen', 'error');
        return;
      }
      await reloadBootstrap();
      showToast('Eingetragen');
    }

    async function withdraw(turnier) {
      const res = await apiAuthed('apiTurnierWithdraw', turnier.turnier_id);
      if (!res || !res.ok) {
        showToast(res && res.error ? res.error : 'Austragen fehlgeschlagen', 'error');
        return;
      }
      await reloadBootstrap();
      showToast('Austragung gespeichert');
    }

    async function setUnavailable(turnier) {
      const grund = prompt('Grund (optional):') || '';
      const res = await apiAuthed('apiTurnierSetUnavailable', turnier.turnier_id, grund);
      if (!res || !res.ok) {
        showToast(res && res.error ? res.error : 'Nicht verfügbar setzen fehlgeschlagen', 'error');
        return;
      }
      await reloadBootstrap();
      showToast('Als nicht verfügbar markiert');
    }

    async function unsetUnavailable(turnier) {
      const res = await apiAuthed('apiTurnierUnsetUnavailable', turnier.turnier_id);
      if (!res || !res.ok) {
        showToast(res && res.error ? res.error : 'Status konnte nicht geändert werden', 'error');
        return;
      }
      await reloadBootstrap();
      showToast('Verfügbarkeit wiederhergestellt');
    }

    async function checkin(turnier) {
      const input = prompt('Gefahrene km (optional):', '');
      const km = input ? Number(input.replace(',', '.')) : 0;
      const res = await apiAuthed('apiTurnierCheckin', turnier.turnier_id, km);
      if (!res || !res.ok) {
        showToast(res && res.error ? res.error : 'Check-in fehlgeschlagen', 'error');
        return;
      }
      await reloadBootstrap();
      showToast('Check-in gespeichert');
    }

    async function reloadBootstrap() {
      const res = await refreshBootstrap(true);
      if (res && res.ok) {
        setData(res);
      }
    }

    return { init, setData };
  })();
</script>
