<div class="section">
  <div class="section-title">Mein Profil</div>
  <div id="profileSummary" class="profile-summary"></div>
</div>

<form id="profileForm" class="form-grid card" novalidate>
  <h3>Kontaktdaten</h3>
  <label class="select-label">
    <span>Email</span>
    <input type="email" id="profileEmail" name="email" placeholder="name@example.com" required />
  </label>
  <label class="select-label">
    <span>Notizen</span>
    <textarea id="profileNotes" name="notizen" rows="3" placeholder="Interne Notizen"></textarea>
  </label>
  <div class="actions">
    <button class="btn primary" type="button" id="profileSaveBtn">Speichern</button>
  </div>
</form>

<form id="pinForm" class="form-grid card" novalidate>
  <h3>PIN ändern</h3>
  <div id="pinError" class="form-error" hidden></div>
    <label class="select-label">
      <span>Aktuelle PIN</span>
      <input
        type="password"
        id="oldPin"
        inputmode="numeric"
        autocomplete="one-time-code"
        maxlength="8"
      />
    </label>
    <label class="select-label">
      <span>Neue PIN</span>
      <input
        type="password"
        id="newPin"
        inputmode="numeric"
        autocomplete="one-time-code"
        maxlength="8"
      />
    </label>
    <label class="select-label">
      <span>Neue PIN bestätigen</span>
      <input
        type="password"
        id="newPin2"
        inputmode="numeric"
        autocomplete="one-time-code"
        maxlength="8"
      />
    </label>
  <div class="actions">
    <button class="btn primary" type="button" id="pinSaveBtn">PIN speichern</button>
  </div>
</form>

<div class="actions" style="margin-top:1rem;">
  <button class="btn ghost" type="button" id="logoutBtnSecondary">Logout</button>
</div>

<script>
  const MehrView = (() => {
    const state = {
      profile: null,
    };

    const els = {};
    const PIN_REGEX = /^\d{4,8}$/;

    function validatePin_(pin) {
      return PIN_REGEX.test((pin || '').trim());
    }

    function setError_(id, msg) {
      const el = document.getElementById(id);
      if (!el) return;
      const text = String(msg || '').trim();
      el.textContent = text;
      el.hidden = !text;
    }

    function clearError_(id) {
      setError_(id, '');
    }

    function cacheElements() {
      els.profileSummary = document.querySelector('#profileSummary');
      els.profileEmail = document.querySelector('#profileEmail');
      els.profileNotes = document.querySelector('#profileNotes');
      els.profileForm = document.querySelector('#profileForm');
      els.profileSaveBtn = document.querySelector('#profileSaveBtn');

      els.pinForm = document.querySelector('#pinForm');
      els.pinError = document.querySelector('#pinError');
      els.oldPin = document.querySelector('#oldPin');
      els.newPin = document.querySelector('#newPin');
      els.newPinConfirm = document.querySelector('#newPin2');
      els.pinSaveBtn = document.querySelector('#pinSaveBtn');

      els.logoutBtnSecondary = document.querySelector('#logoutBtnSecondary');
    }

    function setButtonLoading(btn, loading) {
      if (!btn) return;
      btn.disabled = !!loading;
      if (loading) {
        btn.dataset.prevText = btn.textContent;
        btn.textContent = 'Bitte warten...';
      } else if (btn.dataset.prevText) {
        btn.textContent = btn.dataset.prevText;
        delete btn.dataset.prevText;
      }
    }

    function renderProfileSummary() {
      if (!els.profileSummary) return;
      if (!state.profile) {
        els.profileSummary.innerHTML = '<p class="muted">Profil lädt...</p>';
        return;
      }
      const p = state.profile;
      els.profileSummary.innerHTML = `
        <ul class="list">
          <li><span class="name">${p.name || ''}</span><span class="muted">Name</span></li>
          <li><span class="name">${p.trainer_id || ''}</span><span class="muted">Trainer-ID</span></li>
          <li><span class="name">${p.email || ''}</span><span class="muted">Email</span></li>
          <li><span class="name">${p.rolle_standard || ''}</span><span class="muted">Rolle</span></li>
          <li><span class="name">${p.stundensatz ?? ''} €</span><span class="muted">Stundensatz</span></li>
        </ul>
      `;
    }

    function fillProfileForm() {
      if (!state.profile) return;
      if (els.profileEmail) els.profileEmail.value = state.profile.email || '';
      if (els.profileNotes) els.profileNotes.value = state.profile.notizen || '';
    }

    async function loadProfile(showSpinnerOverlay = false) {
      const t = requireToken_();
      if (!t) {
        hardLogout_("Session abgelaufen.");
        return;
      }
      if (showSpinnerOverlay) showSpinner(true);
      const res = await apiCall('apiGetMyProfile', t);
      if (showSpinnerOverlay) showSpinner(false);
      if (!res || !res.ok || !res.trainer) {
        showToast(res && res.error ? res.error : 'Profil konnte nicht geladen werden', 'error');
        return;
      }
      state.profile = res.trainer;
      renderProfileSummary();
      fillProfileForm();
    }

    async function handleProfileSave(ev) {
      ev?.preventDefault();
      const t = requireToken_();
      if (!t) {
        hardLogout_("Session abgelaufen.");
        return;
      }
      const email = els.profileEmail?.value.trim();
      const notizen = els.profileNotes?.value || '';
      if (!email) {
        showToast('Bitte Email ausfüllen', 'error');
        return;
      }
      setButtonLoading(els.profileSaveBtn, true);
      const res = await apiCall('apiUpdateMyProfile', t, { email, notizen });
      setButtonLoading(els.profileSaveBtn, false);
      if (!res || !res.ok) {
        showToast(res && res.error ? res.error : 'Profil konnte nicht gespeichert werden', 'error');
        return;
      }
      showToast('Profil gespeichert');
      await loadProfile(false);
    }

    async function handlePinSave(ev) {
      ev?.preventDefault();
      console.info('changePin click');
      clearError_('pinError');
      const t = requireToken_();
      if (!t) {
        hardLogout_("Session abgelaufen.");
        return;
      }
      const oldPin = els.oldPin?.value.trim();
      const newPin = els.newPin?.value.trim();
      const confirmPin = els.newPinConfirm?.value.trim();

      if (!oldPin || !newPin || !confirmPin) {
        setError_('pinError', 'Bitte alle Felder ausfüllen');
        return;
      }
      if (!validatePin_(oldPin)) {
        setError_('pinError', 'PIN muss 4–8 Ziffern haben');
        return;
      }
      if (!validatePin_(newPin)) {
        setError_('pinError', 'PIN muss 4–8 Ziffern haben');
        return;
      }
      if (newPin !== confirmPin) {
        setError_('pinError', 'PINs stimmen nicht überein');
        return;
      }

      try {
        setButtonLoading(els.pinSaveBtn, true);
        const res = await apiCall('apiChangeMyPin', t, oldPin, newPin);
        if (!res || !res.ok) {
          const msg = res && res.error ? res.error : 'PIN konnte nicht geändert werden';
          setError_('pinError', msg);
          showToast(msg, 'error');
          return;
        }
        showToast('PIN gespeichert');
        els.oldPin.value = '';
        els.newPin.value = '';
        els.newPinConfirm.value = '';
        clearError_('pinError');
      } catch (err) {
        console.error(err);
        setError_('pinError', 'PIN konnte nicht geändert werden');
      } finally {
        setButtonLoading(els.pinSaveBtn, false);
      }
    }

    function registerProfileEvents() {
      if (els.profileForm) {
        els.profileForm.addEventListener('submit', handleProfileSave);
      }
      if (els.profileSaveBtn) {
        els.profileSaveBtn.addEventListener('click', handleProfileSave);
      }
      if (els.pinForm) {
        els.pinForm.addEventListener('submit', handlePinSave);
      }
      if (els.pinSaveBtn) {
        els.pinSaveBtn.addEventListener('click', handlePinSave);
      }
      if (els.logoutBtnSecondary) {
        els.logoutBtnSecondary.addEventListener('click', () => logout());
      }
      ['oldPin', 'newPin', 'newPin2'].forEach((id) => {
        const el = document.getElementById(id);
        if (el) el.addEventListener('input', () => clearError_('pinError'));
      });
    }

    function init() {
      cacheElements();
      registerProfileEvents();
    }

    function setData() {
      clearError_('pinError');
      loadProfile(false);
    }

    return { init, setData };
  })();
</script>
