<header class="app-header" id="appHeader" style="display:none;">
  <div class="header-row">
    <div class="brand">
      <div class="logo" aria-hidden="true">TT</div>
      <div class="brand-text">
        <p class="title">TrainerTool</p>
        <p class="subtitle">Das Trainertool des KSV Homberg</p>
      </div>
    </div>
    <button class="user-pill" id="btnProfile" type="button" aria-label="Profilmenü öffnen"></button>
  </div>
</header>

<main class="app-main">
  <section id="appView" style="display:none;">
    <div class="card">
      <div class="row-space">
        <h2 id="viewTitle">Trainings</h2>
        <button class="btn ghost" type="button" id="logoutBtn">Logout</button>
      </div>
      <div class="views" id="viewContainer">
        <?!= include('ui_trainings'); ?>
        <?!= include('ui_einsaetze'); ?>
        <?!= include('ui_abrechnung'); ?>
        <?!= include('ui_admin'); ?>
        <?!= include('ui_turniere'); ?>
      </div>
    </div>
  </section>
</main>

<div class="sheet-backdrop" id="profileSheetBackdrop" hidden>
  <div class="sheet" id="profileSheet" role="dialog" aria-modal="true" aria-labelledby="profileSheetTitle">
    <div class="sheet-header">
      <h3 class="sheet-title" id="profileSheetTitle">Profil</h3>
      <button class="icon-btn" type="button" id="closeProfileSheet" aria-label="Profilmenü schließen">×</button>
    </div>
    <div class="sheet-body">
      <?!= include('ui_mehr'); ?>
    </div>
  </div>
</div>

<nav class="bottom-nav" id="bottomNav" style="display:none;" aria-label="Navigation">
  <button class="nav-btn active" data-view="trainings">
    <span class="nav-icon" aria-hidden="true">
      <svg viewBox="0 0 24 24" role="presentation" focusable="false">
        <path d="M12 3 2.5 10l1.4 1.4L5 10.5V20h5v-6h4v6h5V10.5l1.1.9 1.4-1.4L12 3z" />
      </svg>
    </span>
    <span class="nav-label">Trainings</span>
  </button>
  <button class="nav-btn" data-view="einsaetze">
    <span class="nav-icon" aria-hidden="true">
      <svg viewBox="0 0 24 24" role="presentation" focusable="false">
        <path d="M7 4h10a2 2 0 0 1 2 2v12a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2zm0 4h10V6H7v2zm0 4h10v-2H7v2zm0 4h6v-2H7v2z" />
      </svg>
    </span>
    <span class="nav-label">Einsätze</span>
  </button>
  <button class="nav-btn" data-view="abrechnung">
    <span class="nav-icon" aria-hidden="true">
      <svg viewBox="0 0 24 24" role="presentation" focusable="false">
        <path d="M12 3a9 9 0 1 1 0 18 9 9 0 0 1 0-18zm0 4a1 1 0 1 0 0 2c1.3 0 2 .6 2 1.5 0 .7-.5 1.2-1.4 1.6l-.7.3c-1.2.5-1.9 1.2-1.9 2.6V15h2v-.3c0-.7.4-1 1.2-1.4l.6-.3c1.4-.6 2.2-1.5 2.2-3 0-2.1-1.6-3.5-4-3.5zm-1 10h2v2h-2v-2z" />
      </svg>
    </span>
    <span class="nav-label">Abrechnung</span>
  </button>
  <button class="nav-btn" data-view="turniere">
    <span class="nav-icon" aria-hidden="true">
      <svg viewBox="0 0 24 24" role="presentation" focusable="false">
        <path d="M7 4h10l-1 7h-2l2 9-4-3-4 3 2-9H8L7 4z" />
      </svg>
    </span>
    <span class="nav-label">Turniere</span>
  </button>
  <button class="nav-btn" data-view="admin" id="navAdmin" hidden>
    <span class="nav-icon" aria-hidden="true">
      <svg viewBox="0 0 24 24" role="presentation" focusable="false">
        <path d="M12 2 3 6v6c0 5 4 9 9 10 5-1 9-5 9-10V6l-9-4zm-2 13 5-5-1.4-1.4L10 12.2 8.4 10.6 7 12l3 3z" />
      </svg>
    </span>
    <span class="nav-label">Admin</span>
  </button>
</nav>

<script>
  document.body.classList.add("logged-out");

  const LS_TOKEN = "vh_token";
  window.AppState = window.AppState || {};
  AppState.token = AppState.token ?? null;
  AppState.user = AppState.user ?? null;
  window.__vhDebug = window.__vhDebug || { enabled: true, logs: [] };
  let trainerNamesLoaded = false;
  let trainerNamesLoading = false;
  const state = {
    bootstrap: null,
    viewsInitialized: false,
  };

  const qs = (selector) => document.querySelector(selector);
  const qsa = (selector) => Array.from(document.querySelectorAll(selector));

  function dbg_(msg, obj) {
    try {
      const line = `${new Date().toISOString()} | ${msg}${obj ? ` | ${JSON.stringify(obj)}` : ""}`;
      window.__vhDebug.logs.push(line);
      console.log("[VH]", msg, obj || "");
      const el = document.getElementById("debugBox");
      if (el) {
        el.textContent = window.__vhDebug.logs.slice(-30).join("\n");
      }
    } catch (e) {}
  }

  function toggleDebugBox_() {
    const el = document.getElementById("debugBox");
    if (!el) return;
    el.style.display = window.__vhDebug.enabled ? "block" : "none";
  }

  function showSpinner(show) {
    const el = qs("#spinner");
    if (!el) return;
    el.classList.toggle("show", !!show);
  }

  function showLoginStatus(message, debugData) {
    if (!message) return;
    dbg_("login status", { message, debugData });
    const box = qs("#loginError");
    if (box) {
      box.textContent = message;
      box.hidden = false;
    }
    showToast(message);
    if (debugData !== undefined) {
      const debugBox = qs("#loginDebug");
      if (debugBox) {
        debugBox.textContent = JSON.stringify(debugData, null, 2);
        debugBox.hidden = false;
      }
    }
  }

  function showLoginError(message, debugData) {
    dbg_("login error", { message, debugData });
    const box = qs("#loginError");
    if (box) {
      box.textContent = message || "Login fehlgeschlagen.";
      box.hidden = false;
    }

    const debugBox = qs("#loginDebug");
    if (debugBox) {
      if (debugData !== undefined && debugData !== null) {
        debugBox.textContent = JSON.stringify(debugData, null, 2);
        debugBox.hidden = false;
      } else {
        debugBox.textContent = "";
        debugBox.hidden = true;
      }
    }

    if (message) {
      console.error("Login error:", message);
    }
  }

  function clearLoginError() {
    const box = qs("#loginError");
    if (box) {
      box.textContent = "";
      box.hidden = true;
    }

    const debugBox = qs("#loginDebug");
    if (debugBox) {
      debugBox.textContent = "";
      debugBox.hidden = true;
    }
  }

  function showToast(message, type = "info") {
    const el = qs("#toast");
    if (!el || !message) return;
    dbg_("toast", { message, type });
    el.textContent = message;
    el.style.background = type === "error" ? "#b91c1c" : "rgba(15,23,42,0.92)";
    el.classList.add("show");
    setTimeout(() => el.classList.remove("show"), 2500);
  }

  function setLoginButtonDisabled(disabled) {
    const btn = qs("#loginBtn");
    if (btn) {
      btn.disabled = !!disabled;
    }
  }

  function setView(view) {
    if (!isLoggedIn()) return;
    if (view === "admin" && !(AppState.user && AppState.user.is_admin)) {
      view = "trainings";
    }
    qsa(".nav-btn").forEach((btn) => btn.classList.toggle("active", btn.dataset.view === view));
    qsa(".views > section").forEach((section) => section.classList.toggle("active", section.id === `view-${view}`));
    const titleMap = {
      trainings: "Trainings",
      einsaetze: "Einsätze",
      abrechnung: "Abrechnung",
      turniere: "Turniere",
      admin: "Admin",
    };
    const title = qs("#viewTitle");
    if (title) title.textContent = titleMap[view] || "";
  }

  function toggleShell(visible) {
    const appShell = qs("#screen-app");
    const appView = qs("#appView");
    const header = qs("#appHeader");
    const nav = qs("#bottomNav");
    if (appShell) appShell.hidden = !visible;
    if (appView) appView.style.display = visible ? "block" : "none";
    if (header) header.style.display = visible ? "block" : "none";
    if (nav) nav.style.display = visible ? "grid" : "none";
  }

  function setUser(user) {
    AppState.user = user || null;
    const el = qs("#btnProfile");
    if (el) el.textContent = AppState.user ? AppState.user.name || AppState.user.username || "" : "";
    toggleAdminAccess(AppState.user && AppState.user.is_admin);
  }

  function toggleAdminAccess(isAdmin) {
    const navBtn = qs("#navAdmin");
    const nav = qs("#bottomNav");
    const adminSection = qs("#view-admin");
    const allow = !!isAdmin;
    if (navBtn) {
      navBtn.hidden = !allow;
      if (!allow) navBtn.classList.remove("active");
    }
    if (nav) nav.classList.toggle("has-admin", allow);
    if (adminSection) adminSection.style.display = allow ? "block" : "none";
  }

  function setBootstrap(data) {
    state.bootstrap = data || null;
    const bootstrapData = state.bootstrap || {};
    if (bootstrapData.user) {
      setUser(bootstrapData.user);
    }

    try {
      if (typeof TrainingsView !== "undefined" && TrainingsView && typeof TrainingsView.setData === "function") {
        TrainingsView.setData(bootstrapData);
      }
    } catch (err) {
      console.error("TrainingsView.setData failed", err);
    }

    try {
      if (typeof EinsaetzeView !== "undefined" && EinsaetzeView && typeof EinsaetzeView.setData === "function") {
        EinsaetzeView.setData(bootstrapData);
      }
    } catch (err) {
      console.error("EinsaetzeView.setData failed", err);
    }

    try {
      if (typeof AbrechnungView !== "undefined" && AbrechnungView && typeof AbrechnungView.setData === "function") {
        AbrechnungView.setData(bootstrapData);
      }
    } catch (err) {
      console.error("AbrechnungView.setData failed", err);
    }

    try {
      if (typeof TurniereView !== "undefined" && TurniereView && typeof TurniereView.setData === "function") {
        TurniereView.setData(bootstrapData);
      }
    } catch (err) {
      console.error("TurniereView.setData failed", err);
    }

    try {
      if (typeof AdminView !== "undefined" && AdminView && typeof AdminView.setData === "function") {
        AdminView.setData(bootstrapData);
      }
    } catch (err) {
      console.error("AdminView.setData failed", err);
    }

    try {
      if (typeof MehrView !== "undefined" && MehrView && typeof MehrView.setData === "function") {
        MehrView.setData(bootstrapData);
      }
    } catch (err) {
      console.error("MehrView.setData failed", err);
    }
  }

  const API_BASE = window.APP_CONFIG?.apiBase || "/api";
  const API_ROUTES = {
    apiListActiveTrainers: { method: "GET", path: "/trainers/active" },
    apiListActiveTrainerNames: { method: "GET", path: "/trainers/active/names" },
    apiLogin: { method: "POST", path: "/login", body: (identifier, pin) => ({ identifier, pin }) },
    apiLoginByName: { method: "POST", path: "/login/name", body: (name, pin) => ({ name, pin }) },
    apiLogout: { method: "POST", path: "/logout", body: (token) => ({ token }) },
    apiBootstrap: { method: "GET", path: "/bootstrap", query: (token) => ({ token }) },
    apiGetMyProfile: { method: "GET", path: "/me", query: (token) => ({ token }) },
    apiUpdateMyProfile: { method: "PUT", path: "/me", body: (token, payload) => ({ token, ...(payload || {}) }) },
    apiChangeMyPin: { method: "POST", path: "/me/pin", body: (token, oldPin, newPin) => ({ token, oldPin, newPin }) },
    apiTrainingDetails: {
      method: "GET",
      path: (token, trainingId) => `/trainings/${encodeURIComponent(trainingId)}`,
      query: (token) => ({ token }),
    },
    apiEnroll: {
      method: "POST",
      path: (token, trainingId) => `/trainings/${encodeURIComponent(trainingId)}/enroll`,
      body: (token) => ({ token }),
    },
    apiWithdraw: {
      method: "POST",
      path: (token, einteilungId) => `/enrollments/${encodeURIComponent(einteilungId)}/withdraw`,
      body: (token) => ({ token }),
    },
    apiCheckin: {
      method: "POST",
      path: (token, einteilungId) => `/enrollments/${encodeURIComponent(einteilungId)}/checkin`,
      body: (token, einteilungId, mode) => ({ token, mode }),
    },
    apiAdminSetTrainingStatus: {
      method: "POST",
      path: (token, trainingId) => `/trainings/${encodeURIComponent(trainingId)}/status`,
      body: (token, trainingId, status, reason) => ({ token, status, reason }),
    },
    apiTurniereList: { method: "GET", path: "/turniere", query: (token) => ({ token }) },
    apiTurnierDetails: {
      method: "GET",
      path: (token, turnierId) => `/turniere/${encodeURIComponent(turnierId)}`,
      query: (token) => ({ token }),
    },
    apiTurnierEnroll: {
      method: "POST",
      path: (token, turnierId) => `/turniere/${encodeURIComponent(turnierId)}/enroll`,
      body: (token) => ({ token }),
    },
    apiTurnierWithdraw: {
      method: "POST",
      path: (token, turnierEinsatzId) => `/turnier-einsaetze/${encodeURIComponent(turnierEinsatzId)}/withdraw`,
      body: (token) => ({ token }),
    },
    apiTurnierSetUnavailable: {
      method: "POST",
      path: (token, turnierId) => `/turniere/${encodeURIComponent(turnierId)}/unavailable`,
      body: (token, turnierId, grund) => ({ token, grund }),
    },
    apiTurnierUnsetUnavailable: {
      method: "DELETE",
      path: (token, turnierId) => `/turniere/${encodeURIComponent(turnierId)}/unavailable`,
      body: (token) => ({ token }),
    },
    apiTurnierCheckin: {
      method: "POST",
      path: (token, turnierId) => `/turniere/${encodeURIComponent(turnierId)}/checkin`,
      body: (token, turnierId, kmGesamt) => ({ token, kmGesamt }),
    },
    apiAdminDashboard: { method: "GET", path: "/admin/dashboard", query: (token) => ({ token }) },
    apiAdminListTrainings: { method: "GET", path: "/admin/trainings", query: (token, filters) => ({ token, ...(filters || {}) }) },
    apiAdminUpsertTraining: { method: "POST", path: "/admin/trainings", body: (token, payload) => ({ token, ...(payload || {}) }) },
    apiAdminDeleteTraining: {
      method: "DELETE",
      path: (token, trainingId) => `/admin/trainings/${encodeURIComponent(trainingId)}`,
      body: (token) => ({ token }),
    },
    apiAdminUpsertTrainingPlan: {
      method: "POST",
      path: (token, trainingId) => `/admin/trainings/${encodeURIComponent(trainingId)}/plan`,
      body: (token, trainingId, payload) => ({ token, ...(payload || {}) }),
    },
    apiAdminDeleteTrainingPlan: {
      method: "DELETE",
      path: (token, planId) => `/admin/trainings/plan/${encodeURIComponent(planId)}`,
      body: (token) => ({ token }),
    },
    apiAdminListTurniere: { method: "GET", path: "/admin/turniere", query: (token) => ({ token }) },
    apiAdminUpsertTurnier: { method: "POST", path: "/admin/turniere", body: (token, payload) => ({ token, ...(payload || {}) }) },
    apiAdminDeleteTurnier: {
      method: "DELETE",
      path: (token, turnierId) => `/admin/turniere/${encodeURIComponent(turnierId)}`,
      body: (token) => ({ token }),
    },
    apiAdminListRoles: { method: "GET", path: "/admin/roles", query: (token) => ({ token }) },
    apiAdminListTrainers: { method: "GET", path: "/admin/trainers", query: (token) => ({ token }) },
    apiAdminUpsertTrainer: { method: "POST", path: "/admin/trainers", body: (token, payload) => ({ token, ...(payload || {}) }) },
    apiAdminResetTrainerPin: {
      method: "POST",
      path: (token, trainerId) => `/admin/trainers/${encodeURIComponent(trainerId)}/reset-pin`,
      body: (token, trainerId, newPin) => ({ token, newPin }),
    },
    apiAdminBillingOverview: {
      method: "GET",
      path: "/admin/billing/overview",
      query: (token, year, half) => ({ token, year, half }),
    },
    apiBillingHalfyear: { method: "GET", path: "/billing/halfyear", query: (token, year, half) => ({ token, year, half }) },
    apiSetUnavailable: {
      method: "POST",
      path: (token, trainingId) => `/trainings/${encodeURIComponent(trainingId)}/unavailable`,
      body: (token, trainingId, grund) => ({ token, grund }),
    },
    apiUnsetUnavailable: {
      method: "DELETE",
      path: (token, trainingId) => `/trainings/${encodeURIComponent(trainingId)}/unavailable`,
      body: (token) => ({ token }),
    },
  };

  function buildQueryString(params) {
    if (!params) return "";
    const searchParams = new URLSearchParams();
    Object.entries(params).forEach(([key, value]) => {
      if (value === undefined || value === null || value === "") return;
      searchParams.append(key, String(value));
    });
    const query = searchParams.toString();
    return query ? `?${query}` : "";
  }

  async function apiCall(name, ...args) {
    dbg_("apiCall start", { name, argsPreview: args.map((arg) => typeof arg) });
    const route = API_ROUTES[name];
    if (!route) {
      const error = `Unbekannter API-Aufruf: ${name}`;
      dbg_("apiCall failure", { name, error });
      return { ok: false, error };
    }

    const method = route.method || "GET";
    const path = typeof route.path === "function" ? route.path(...args) : route.path;
    const query = route.query ? route.query(...args) : null;
    const url = `${API_BASE}${path}${buildQueryString(query)}`;
    const headers = { "Content-Type": "application/json" };
    const options = { method, headers };
    if (!["GET", "HEAD"].includes(method)) {
      const body = route.body ? route.body(...args) : {};
      options.body = JSON.stringify(body || {});
    }

    try {
      const response = await fetch(url, options);
      const data = await response.json().catch(() => null);
      const payload = data && typeof data === "object" ? data : { ok: false, error: "Ungültige Serverantwort." };
      if (!response.ok && payload.ok !== false) {
        payload.ok = false;
        payload.error = payload.error || "Serverfehler.";
      }
      dbg_("apiCall success", { name, res: payload });
      return payload;
    } catch (err) {
      const message = err && err.message ? err.message : String(err || "Unbekannter Fehler");
      dbg_("apiCall failure", { name, message });
      return { ok: false, error: message };
    }
  }

  function gasCall_(fnName, args, { onOk, onErr } = {}) {
    dbg_("gasCall start", { fnName, argsPreview: (args || []).map((arg) => typeof arg) });
    apiCall(fnName, ...(args || []))
      .then((res) => {
        dbg_("gasCall success", { fnName, res });
        if (onOk) onOk(res);
      })
      .catch((err) => {
        const msg = err && err.message ? err.message : String(err);
        dbg_("gasCall failure", { fnName, msg });
        if (onErr) onErr(msg, err);
      });
  }

  function apiAuthed(name, ...args) {
    const t = requireToken_();
    if (!t) {
      return Promise.resolve({ ok: false, error: "Session abgelaufen." });
    }
    return apiCall(name, t, ...args);
  }

  function getToken() {
    return AppState.token;
  }

  function requireToken_() {
    const t = AppState.token;
    if (!t) return null;
    const trimmed = String(t).trim();
    return trimmed ? trimmed : null;
  }

  function hardLogout_(message) {
    const finalMessage = message || "Session abgelaufen.";
    dbg_("hardLogout", { message: finalMessage });
    AppState.token = null;
    AppState.user = null;
    localStorage.removeItem(LS_TOKEN);
    applyLoggedOutUi();
    setUser(null);
    setBootstrap(null);
    renderLogin();
    showLoginError(finalMessage);
    showToast(finalMessage, "error");
  }

  function setAuth(state) {
    const html = document.documentElement;
    const next = state === "in" ? "in" : "out";
    if (html) html.dataset.auth = next;

    const isLoggedInState = next === "in";
    document.body.classList.toggle("logged-in", isLoggedInState);
    document.body.classList.toggle("logged-out", !isLoggedInState);
  }

  function isLoggedIn() {
    return document.body.classList.contains("logged-in");
  }

  function applyLoggedOutUi() {
    setAuth("out");
    toggleShell(false);
  }

  async function loadTrainerNames() {
    const input = qs("#trainerName");
    if (!input) return;
    if (trainerNamesLoaded && qs("#trainerNames")) return;
    if (trainerNamesLoading) return;
    trainerNamesLoading = true;

    try {
      const res = await apiCall("apiListActiveTrainers");
      const names = Array.isArray(res?.items)
        ? res.items.map((item) => item?.name).filter(Boolean)
        : [];
      if (!names || names.length === 0) {
        return;
      }

      let dataList = qs("#trainerNames");
      if (!dataList) {
        dataList = document.createElement("datalist");
        dataList.id = "trainerNames";
        input.setAttribute("list", dataList.id);
        input.insertAdjacentElement("afterend", dataList);
      }

      dataList.innerHTML = "";
      [...new Set(names)].sort((a, b) => a.localeCompare(b, "de")).forEach((name) => {
        const option = document.createElement("option");
        option.value = name;
        dataList.appendChild(option);
      });
      trainerNamesLoaded = true;
    } catch (err) {
      const message = err && err.message ? err.message : "Trainerliste konnte nicht geladen werden.";
      showLoginError(message);
      console.error("loadTrainerNames failed", err);
    } finally {
      trainerNamesLoading = false;
    }
  }

  function renderLogin() {
    applyLoggedOutUi();
    clearCandidateSelection();
    clearLoginError();
    toggleDebugBox_();
    loadTrainerNames();
  }

  function clearCandidateSelection() {
    const container = qs("#loginCandidates");
    const list = qs("#candidateList");
    if (list) list.innerHTML = "";
    if (container) container.hidden = true;
  }

  function renderCandidateSelection(candidates = []) {
    const container = qs("#loginCandidates");
    const list = qs("#candidateList");
    if (!container || !list) return;

    list.innerHTML = "";
    candidates.forEach((candidate) => {
      const btn = document.createElement("button");
      btn.type = "button";
      btn.className = "btn ghost";
      btn.textContent = candidate.name || candidate.trainer_id || "Unbekannt";
      btn.addEventListener("click", () => handleCandidateLogin(candidate.trainer_id));
      list.appendChild(btn);
    });

    container.hidden = candidates.length === 0;
  }

  function renderApp() {
    if (document.documentElement.dataset.auth !== "in") return;

    try {
      if (!state.viewsInitialized) {
        initNavigation();
        initLogout();
        initProfileSheet();
        if (typeof TrainingsView !== "undefined" && TrainingsView && typeof TrainingsView.init === "function") {
          TrainingsView.init();
        }
        if (typeof EinsaetzeView !== "undefined" && EinsaetzeView && typeof EinsaetzeView.init === "function") {
          EinsaetzeView.init();
        }
        if (typeof AbrechnungView !== "undefined" && AbrechnungView && typeof AbrechnungView.init === "function") {
          AbrechnungView.init();
        }
        if (typeof TurniereView !== "undefined" && TurniereView && typeof TurniereView.init === "function") {
          TurniereView.init();
        }
        if (typeof AdminView !== "undefined" && AdminView && typeof AdminView.init === "function") {
          AdminView.init();
        }
        if (typeof MehrView !== "undefined" && MehrView && typeof MehrView.init === "function") {
          MehrView.init();
        }
        state.viewsInitialized = true;
      }
    } catch (err) {
      console.error("Render app failed", err);
      showToast("Ansicht konnte nicht geladen werden.", "error");
    }

    toggleShell(true);
    setView("trainings");
  }

  function handleLogin(event) {
    event.preventDefault();
    clearLoginError();
    doLogin();
  }

  function onLoginClick_() {
    const trainerName = qs("#trainerName")?.value.trim() || "";
    const pin = qs("#pin")?.value.trim() || "";
    dbg_("onLoginClick_ start", { name: trainerName, pinLen: pin ? pin.length : 0 });
    showLoginStatus("Login wird geprüft…");
    doLogin();
  }

  function doLogin() {
    clearCandidateSelection();
    clearLoginError();

    const trainerName = qs("#trainerName")?.value.trim() || "";
    const pin = qs("#pin")?.value.trim() || "";
    dbg_("doLogin start", { name: trainerName, pinLen: pin ? pin.length : 0 });

    if (!trainerName || !pin || !/^\d{4,8}$/.test(pin)) {
      showLoginError("Bitte Namen eingeben und PIN (4-8 Ziffern).");
      return;
    }

    setLoginButtonDisabled(true);
    console.info("Login request (by name)", trainerName);
    showSpinner(true);
    showLoginStatus("Login wird geprüft …");
    gasCall_("apiLoginByName", [trainerName, pin], {
      onOk: (res) => handleLoginResponse(res),
      onErr: (msg, err) => {
        showSpinner(false);
        setLoginButtonDisabled(false);
        showLoginError(`Serverfehler: ${msg}`, err);
      },
    });
  }

  function handleLoginResponse(res) {
    console.info("Login response", res);
    dbg_("login response", res);
    showSpinner(false);
    setLoginButtonDisabled(false);

    if (res && Array.isArray(res.candidates) && res.candidates.length) {
      renderCandidateSelection(res.candidates);
      showLoginError(res.error || "Bitte Person auswählen.");
      return;
    }

    if (!res || !res.ok || !res.token) {
      showLoginError(res && res.error ? res.error : "Login fehlgeschlagen.");
      return;
    }

    clearCandidateSelection();
    clearLoginError();
    showToast("Eingeloggt");
    finalizeLogin(res.token, res.user);
  }

  function handleCandidateLogin(trainerId) {
    clearLoginError();
    const pinInput = qs("#pin");
    const pin = (pinInput?.value || "").trim();
    if (!trainerId || !pin) {
      showLoginError("Bitte PIN eingeben.");
      return;
    }

    console.info("Login request (by candidate)", trainerId);
    showSpinner(true);
    gasCall_("apiLogin", [trainerId, pin], {
      onOk: (res) => handleLoginResponse(res),
      onErr: (msg, err) => {
        showSpinner(false);
        showLoginError(`Serverfehler: ${msg}`, err);
      },
    });
  }

  function finalizeLogin(newToken, user) {
    AppState.token = String(newToken || "").trim() || null;
    if (!AppState.token) {
      showLoginError("Login fehlgeschlagen (kein Token).");
      return;
    }
    localStorage.setItem(LS_TOKEN, AppState.token);
    dbg_("token stored", { tokenLen: AppState.token.length });
    AppState.user = user || null;
    runBootstrap_();
  }

  function runBootstrap_() {
    const t = requireToken_();
    if (!t) {
      dbg_("bootstrap aborted - missing token");
      showLogin_("Keine Session. Bitte einloggen.");
      return false;
    }
    showSpinner(true);
    console.info("Bootstrap request");
    showLoginStatus("Bootstrap wird geladen …");
    gasCall_("apiBootstrap", [t], {
      onOk: (res) => handleBootstrapResponse(res),
      onErr: (msg) => {
        showSpinner(false);
        handleBootstrapResponse({ ok: false, error: msg || "Bootstrap fehlgeschlagen." });
      },
    });
    return true;
  }

  function handleBootstrapResponse(res) {
    console.info("Bootstrap response", res);
    dbg_("bootstrap response", res);
    showSpinner(false);
    if (res && res.ok) {
      console.info("Bootstrap ok");
      setAuth("in");
      toggleShell(true);
      setUser(res.user || AppState.user || {});
      try {
        setBootstrap(res);
      } catch (err) {
        console.error("setBootstrap failed", err);
        showToast("Daten konnten nicht geladen werden.", "error");
      }
      try {
        renderApp();
      } catch (err) {
        console.error("renderApp failed", err);
        showToast("App konnte nicht angezeigt werden.", "error");
      }
      showToast("Bootstrap abgeschlossen");
      return true;
    }

    const message = res && res.error ? res.error : "Session abgelaufen.";
    if (/Session abgelaufen/i.test(message)) {
      hardLogout_(message);
      return false;
    }
    showLoginError(message);
    showToast(message, "error");
    return false;
  }

  async function refreshBootstrap(showSpinnerOverlay = false) {
    const t = requireToken_();
    if (!t) {
      showLogin_("Keine Session. Bitte einloggen.");
      return null;
    }
    if (showSpinnerOverlay) showSpinner(true);
    const res = await apiCall("apiBootstrap", t);
    if (showSpinnerOverlay) showSpinner(false);
    if (res && res.ok) {
      setBootstrap(res);
      return res;
    }

    const message = res && res.error ? res.error : "Session abgelaufen.";
    if (/Session abgelaufen/i.test(message)) {
      hardLogout_(message);
    } else {
      showLoginError(message);
      showToast(message, "error");
    }
    return res;
  }

  async function logout(silent = false) {
    const currentToken = requireToken_();
    hardLogout_();
    if (currentToken) {
      apiCall("apiLogout", currentToken);
    }
    if (!silent) showToast("Abgemeldet");
  }

  function initNavigation() {
    qsa(".nav-btn").forEach((btn) => {
      btn.addEventListener("click", () => setView(btn.dataset.view));
    });
  }

  function initLogin() {
    const form = qs("#loginForm");
    if (form) {
      form.setAttribute("novalidate", "novalidate");
      form.addEventListener("submit", (event) => {
        event.stopPropagation();
        event.preventDefault();
        dbg_("submit login");
        onLoginClick_();
      });
    }

    const pinInput = qs("#pin");
    if (pinInput) {
      pinInput.addEventListener("keydown", (event) => {
        if (event.key === "Enter") {
          event.preventDefault();
          dbg_("keydown enter login");
          onLoginClick_();
        }
      });
    }

    const loginBtn = qs("#loginBtn");
    if (loginBtn) {
      if (!loginBtn.dataset.bound) {
        loginBtn.dataset.bound = "true";
        loginBtn.addEventListener("click", (event) => {
          event.preventDefault();
          dbg_("CLICK login");
          onLoginClick_();
        });
      }
    }

    toggleDebugBox_();
  }

  function initLogout() {
    const btn = qs("#logoutBtn");
    if (btn) btn.addEventListener("click", () => logout());
  }

  function openProfileSheet() {
    const backdrop = qs("#profileSheetBackdrop");
    if (!backdrop) return;
    backdrop.hidden = false;
  }

  function closeProfileSheet() {
    const backdrop = qs("#profileSheetBackdrop");
    if (!backdrop) return;
    backdrop.hidden = true;
  }

  function initProfileSheet() {
    const backdrop = qs("#profileSheetBackdrop");
    const sheet = qs("#profileSheet");
    const closeBtn = qs("#closeProfileSheet");
    const profileBtn = qs("#btnProfile");
    if (backdrop) backdrop.hidden = true;
    if (profileBtn) profileBtn.addEventListener("click", openProfileSheet);
    if (closeBtn) closeBtn.addEventListener("click", closeProfileSheet);
    if (backdrop && sheet) {
      backdrop.addEventListener("click", (event) => {
        if (event.target === backdrop) {
          closeProfileSheet();
        }
      });
    }
  }

  function showLogin_(message) {
    applyLoggedOutUi();
    renderLogin();
    if (message) showLoginError(message);
  }

  function initAuth() {
    const saved = localStorage.getItem(LS_TOKEN);
    AppState.token = saved && String(saved).trim() ? String(saved).trim() : null;
    if (!AppState.token) {
      showLogin_();
      return;
    }

    runBootstrap_();
  }

  async function initApp() {
    initLogin();
    initAuth();
  }

  document.addEventListener("DOMContentLoaded", initApp);
</script>
